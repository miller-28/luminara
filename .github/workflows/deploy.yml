name: Deploy sandbox + docs to EC2 serving Luminara.website

on:
  push:
    branches: [ master ]

concurrency:
  group: luminara-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Build luminara so that dist/ exists in the clone
      - name: Install deps & build luminara
        run: |
          set -euo pipefail
          npm ci
          npm run build

      - name: Prepare release from sandbox + docs + dist
        env:
          RELEASES_DIR: /var/projects/remote_repos/luminara/releases
          CURRENT_LINK: /var/projects/remote_repos/luminara/current
          NGINX_ROOT: /var/projects/www/luminara.website/client
        run: |
          set -euo pipefail

          TS=$(date +"%Y-%m-%d_%H-%M-%S")
          TARGET="$RELEASES_DIR/$TS"

          echo "Creating release directory: $TARGET"
          mkdir -p "$TARGET"

          echo "Copying sandbox/ into release root"
          rsync -a --delete sandbox/ "$TARGET"/

          echo "Copying docs/ into release/docs/"
          mkdir -p "$TARGET/docs"
          rsync -a docs/ "$TARGET/docs"/

          echo "Copying built dist/ into release/dist/"
          mkdir -p "$TARGET/dist"
          rsync -a dist/ "$TARGET/dist"/

          echo "Copying benchmark/browser/ into release/benchmark/"
          mkdir -p "$TARGET/benchmark"
          rsync -a benchmark/browser/ "$TARGET/benchmark"/

          # (No npm install here, release is pure static assets)

          echo "Pointing 'current' symlink to new release"
          ln -sfn "$TARGET" "$CURRENT_LINK"

          echo "Syncing current release to Nginx root: $NGINX_ROOT"
          mkdir -p "$NGINX_ROOT"
          rsync -a --delete "$CURRENT_LINK"/ "$NGINX_ROOT"/

          echo "Cleaning old releases (keep last 10)"
          ls -1dt "$RELEASES_DIR"/* | tail -n +11 | xargs -r rm -rf
  
      - name: Test Nginx & reload
        run: |
          sudo nginx -t
          sudo systemctl reload nginx

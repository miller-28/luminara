@startuml Stats System Architecture
!theme plain
skinparam backgroundColor #FEFEFE
skinparam shadowing false

title Luminara - Stats System Data Flow

actor "User Code" as User
participant "LuminaraClient" as Client
participant "StatsHub" as Stats
participant "Counters\nModule" as Counters
participant "Time\nModule" as Time
participant "Retry\nModule" as Retry
participant "Error\nModule" as Error
participant "Rate\nModule" as Rate

User -> Client: api.get('/users')
activate Client

Client -> Stats: onRequestStart(event)
activate Stats

Stats -> Stats: Enrich event metadata\n(domain, endpoint, method)

Stats -> Counters: onRequestStart(event)
activate Counters
Counters -> Counters: Increment pending
Counters -> Counters: Update windows\n(since-start, since-reset, 60s)
deactivate Counters

Stats -> Rate: onRequestStart(event)
activate Rate
Rate -> Rate: Track request timestamp
Rate -> Rate: Calculate EMA rate
deactivate Rate

deactivate Stats

Client -> Client: Execute request

alt Request Success

	Client -> Stats: onRequestSuccess(event)
	activate Stats
	
	Stats -> Counters: onRequestSuccess(event)
	activate Counters
	Counters -> Counters: Decrement pending\nIncrement success
	deactivate Counters
	
	Stats -> Time: onRequestSuccess(event)
	activate Time
	Time -> Time: Record duration\nUpdate min/max/avg
	deactivate Time
	
	Stats -> Retry: onRequestSuccess(event)
	activate Retry
	Retry -> Retry: Track retry count\nif retried
	deactivate Retry
	
	deactivate Stats

else Request Failure

	Client -> Stats: onRequestFail(event)
	activate Stats
	
	Stats -> Counters: onRequestFail(event)
	activate Counters
	Counters -> Counters: Decrement pending\nIncrement failed
	deactivate Counters
	
	Stats -> Time: onRequestFail(event)
	activate Time
	Time -> Time: Record duration
	deactivate Time
	
	Stats -> Error: onRequestFail(event)
	activate Error
	Error -> Error: Categorize error\n(network, timeout, 4xx, 5xx)
	Error -> Error: Store error metadata
	deactivate Error
	
	deactivate Stats

else Request Retry

	Client -> Stats: onRequestRetry(event)
	activate Stats
	
	Stats -> Counters: onRequestRetry(event)
	activate Counters
	Counters -> Counters: Increment retried
	deactivate Counters
	
	Stats -> Retry: onRequestRetry(event)
	activate Retry
	Retry -> Retry: Track retry attempt\nand reason
	deactivate Retry
	
	deactivate Stats

end

User -> Stats: api.stats.query({...})
activate Stats

Stats -> Stats: Execute query engine

alt Group by domain
	Stats -> Counters: getGroupedMetrics('domain')
	activate Counters
	Counters --> Stats: Grouped data
	deactivate Counters
else Filter by endpoint
	Stats -> Time: getMetrics(where: {endpoint})
	activate Time
	Time --> Stats: Filtered data
	deactivate Time
else Get rate metrics
	Stats -> Rate: getMetrics(mode: 'ema-30s')
	activate Rate
	Rate --> Stats: Rate data
	deactivate Rate
end

Stats --> User: Query results
deactivate Stats

deactivate Client

@enduml

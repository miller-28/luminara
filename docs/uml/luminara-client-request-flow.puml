@startuml luminara-client-request-flow
!theme plain

title LuminaraClient Request Flow - Refactored Architecture

actor User
participant "LuminaraClient" as LC
participant "ConfigManager" as CM
participant "ContextBuilder" as CB
participant "SignalManager" as SM
participant "StatsEventEmitter" as SEE
participant "RetryOrchestrator" as RO
participant "PluginPipeline" as PP
participant "NativeFetchDriver" as NFD

User -> LC: request(options)
activate LC

LC -> CM: merge(options)
activate CM
CM --> LC: mergedReq
deactivate CM

LC -> CM: applyRateLimit(mergedReq)
activate CM
CM --> LC: rate limit applied
deactivate CM

LC -> LC: #actualRequest(mergedReq)

LC -> CB: build(mergedReq, driver)
activate CB
CB --> LC: context (with requestId)
deactivate CB

LC -> SEE: emit('request:start', data)
activate SEE
SEE --> LC: stats logged
deactivate SEE

LC -> SM: mergeUserSignal(context, signal, statsEmitter)
activate SM
SM --> LC: signals merged
deactivate SM

LC -> RO: execute(context, pluginPipeline)
activate RO

loop for each attempt (1 to maxAttempts)
	RO -> RO: reset context.error and context.res
	
	RO -> PP: executeOnRequest(context)
	activate PP
	PP -> PP: L→R plugin execution
	PP --> RO: context.req modified
	deactivate PP
	
	RO -> NFD: request(context.req)
	activate NFD
	
	alt Success
		NFD --> RO: response
		deactivate NFD
		
		RO -> PP: executeOnResponse(context)
		activate PP
		PP -> PP: R→L plugin execution
		PP --> RO: context.res modified
		deactivate PP
		
		RO -> SEE: emit('request:success', data)
		activate SEE
		SEE --> RO: stats logged
		deactivate SEE
		
		RO --> LC: response
		deactivate RO
		
		LC --> User: response
		deactivate LC
		
	else Error
		NFD --> RO: throw error
		deactivate NFD
		
		RO -> PP: executeOnResponseError(context)
		activate PP
		PP -> PP: R→L plugin execution
		PP --> RO: context modified
		deactivate PP
		
		alt Should Retry
			RO -> RO: shouldRetry(error, context)
			RO -> RO: getRetryDelay(context)
			
			RO -> SEE: emit('request:retry', data)
			activate SEE
			SEE --> RO: stats logged
			deactivate SEE
			
			RO -> RO: await delay
			note right: Continue to next attempt
			
		else No More Retries
			RO -> SEE: emit('request:fail', data)
			activate SEE
			SEE --> RO: stats logged
			deactivate SEE
			
			RO --> LC: throw error
			deactivate RO
			
			LC --> User: throw error
			deactivate LC
		end
	end
end

@enduml

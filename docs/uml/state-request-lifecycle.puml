@startuml State Machine - Request States
!theme plain
skinparam backgroundColor #FEFEFE
skinparam shadowing false

title Luminara - Request State Machine

[*] --> Idle

Idle --> Preparing : user calls api.get/post/etc
Preparing --> PluginRequest : config built
PluginRequest --> Queued : onRequest hooks executed
Queued --> Executing : driver.request() called

state Executing {
	[*] --> URLBuilding
	URLBuilding --> TimeoutSetup : URL resolved
	TimeoutSetup --> RetryInit : timeout controller created
	RetryInit --> Fetching : retry context ready
	
	state "Retry Loop" as RetryLoop {
		Fetching --> Pending : HTTP request sent
		Pending --> ResponseReceived : network response
		
		ResponseReceived --> ResponseParsing : status OK
		ResponseParsing --> ResponseValidation : data parsed
		
		ResponseReceived --> ErrorCheck : status error
		ErrorCheck --> ShouldRetry : network/timeout error
		
		ShouldRetry --> BackoffWait : retry allowed
		BackoffWait --> Fetching : delay complete
		
		ShouldRetry --> FinalError : max retries reached
	}
	
	ResponseValidation --> [*] : valid response
	FinalError --> [*] : error object
}

Executing --> PluginSuccess : success response
Executing --> PluginError : final error

PluginSuccess --> StatsSuccess : onSuccess hooks
PluginError --> StatsError : onError hooks

StatsSuccess --> Completed : stats recorded
StatsError --> Failed : stats recorded

Completed --> [*] : return data
Failed --> [*] : throw error

note right of BackoffWait
	Backoff strategies:
	• Linear
	• Exponential
	• Fibonacci
	• Decorrelated Jitter
end note

note right of StatsSuccess
	Stats tracking:
	• Request count
	• Success/failure
	• Duration
	• Retry count
	• Error types
end note

@enduml

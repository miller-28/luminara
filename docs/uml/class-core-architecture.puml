@startuml Class Diagram - Core Architecture
!theme plain
skinparam backgroundColor #FEFEFE
skinparam shadowing false

title Luminara - Core Class Architecture

package "Core" {
	class LuminaraClient {
		-driver: Driver
		-plugins: Plugin[]
		-config: ClientConfig
		-stats: StatsHub
		+use(plugin): void
		+request(config): Promise
		+get(url, options): Promise
		+post(url, body, options): Promise
		+put(url, body, options): Promise
		+delete(url, options): Promise
		-executePluginHook(hook, data): any
		-handleRequest(config): Promise
	}
	
	interface Plugin {
		+onRequest?(request): Request
		+onSuccess?(response): Response
		+onError?(error, request): any
	}
	
	class StatsHub {
		-modules: ModuleMap
		-queryEngine: QueryEngine
		-activeRequests: Map
		+query(options): QueryResult
		+snapshot(): Snapshot
		+reset(): void
		+onRequestStart(event): void
		+onRequestSuccess(event): void
		+onRequestFail(event): void
		+onRequestRetry(event): void
	}
}

package "Drivers" {
	interface Driver {
		+request(config): Promise
		+supports(feature): boolean
	}
	
	class OfetchDriver {
		-ofetch: FetchInstance
		+request(config): Promise
		-buildFetchOptions(config): FetchOptions
		-handleRetry(config): RetryConfig
		-handleBackoff(config): BackoffConfig
	}
	
	class NativeDriver {
		-fetch: Fetch
		-features: FeatureMap
		+request(config): Promise
		-buildRequest(config): Request
		-executeWithFeatures(request): Promise
	}
}

package "Features (Native Driver)" {
	class RetryFeature {
		+handle(request, context): Promise
		-shouldRetry(error, attempt): boolean
		-calculateBackoff(attempt, strategy): number
	}
	
	class TimeoutFeature {
		+handle(request, context): Promise
		-createTimeoutController(ms): AbortController
	}
	
	class ErrorFeature {
		+handle(response, context): Response
		-categorizeError(error): ErrorType
		-shouldIgnoreError(status, config): boolean
	}
	
	class ResponseFeature {
		+parseResponse(response, type): any
		-detectContentType(response): string
		-parseJson(response): object
		-parseText(response): string
	}
	
	class UrlFeature {
		+buildUrl(config): string
		-resolveBaseUrl(url, base): string
		-appendQuery(url, params): string
	}
}

package "Stats Modules" {
	class CountersModule {
		-windows: TimeWindow[]
		+onRequestStart(event): void
		+onRequestSuccess(event): void
		+getMetrics(window): Metrics
	}
	
	class TimeModule {
		-durations: Map
		+onRequestSuccess(event): void
		+getMetrics(window): TimeMetrics
	}
	
	class RetryModule {
		-retryData: Map
		+onRequestRetry(event): void
		+getMetrics(window): RetryMetrics
	}
	
	class ErrorModule {
		-errors: Map
		+onRequestFail(event): void
		+getMetrics(window): ErrorMetrics
	}
	
	class RateModule {
		-timestamps: Array
		+onRequestStart(event): void
		+calculateRate(mode): number
	}
}

' Relationships
LuminaraClient --> Driver : uses
LuminaraClient --> Plugin : manages
LuminaraClient --> StatsHub : tracks with

OfetchDriver ..|> Driver
NativeDriver ..|> Driver

NativeDriver --> RetryFeature : uses
NativeDriver --> TimeoutFeature : uses
NativeDriver --> ErrorFeature : uses
NativeDriver --> ResponseFeature : uses
NativeDriver --> UrlFeature : uses

StatsHub --> CountersModule : manages
StatsHub --> TimeModule : manages
StatsHub --> RetryModule : manages
StatsHub --> ErrorModule : manages
StatsHub --> RateModule : manages

@enduml

@startuml Plugin Lifecycle and Interceptors
!theme plain
skinparam backgroundColor #FEFEFE
skinparam shadowing false

title Luminara - Plugin Lifecycle & Enhanced Interceptors

actor "User Code" as User
participant "LuminaraClient" as Client
participant "Plugin 1\n(Logger)" as P1
participant "Plugin 2\n(Auth)" as P2
participant "Plugin 3\n(Transform)" as P3
participant "Driver" as Driver

User -> Client: api.use(loggerPlugin)\napi.use(authPlugin)\napi.use(transformPlugin)

User -> Client: api.get('/users')
activate Client

== onRequest Phase ==

Client -> P1: onRequest(request)
activate P1
P1 -> P1: Log request details
P1 --> Client: request (unmodified)
deactivate P1

Client -> P2: onRequest(request)
activate P2
P2 -> P2: Add Authorization header
P2 --> Client: Modified request
deactivate P2

Client -> P3: onRequest(request)
activate P3
P3 -> P3: Transform request data
P3 --> Client: Modified request
deactivate P3

== Driver Execution ==

Client -> Driver: Execute request
activate Driver
Driver --> Client: Response / Error
deactivate Driver

alt Success Path

	== onSuccess Phase ==
	
	Client -> P1: onSuccess(response)
	activate P1
	P1 -> P1: Log response
	P1 --> Client: response
	deactivate P1
	
	Client -> P2: onSuccess(response)
	activate P2
	P2 -> P2: Check auth validity
	P2 --> Client: response
	deactivate P2
	
	Client -> P3: onSuccess(response)
	activate P3
	P3 -> P3: Transform response data
	P3 --> Client: Modified response
	deactivate P3
	
	Client --> User: Final response

else Error Path

	== onError Phase ==
	
	Client -> P1: onError(error, request)
	activate P1
	P1 -> P1: Log error details
	P1 --> Client: error
	deactivate P1
	
	Client -> P2: onError(error, request)
	activate P2
	alt Auth error (401)
		P2 -> P2: Refresh token
		P2 -> Client: Retry with new token
	else Other error
		P2 --> Client: error
	end
	deactivate P2
	
	Client -> P3: onError(error, request)
	activate P3
	P3 -> P3: Transform error
	P3 --> Client: Modified error
	deactivate P3
	
	Client --> User: Throw error

end

deactivate Client

@enduml
